import pandas as pd
import os
from geopy.geocoders import Nominatim
from geopy.exc import GeocoderTimedOut, GeocoderUnavailable
import time

# Defina o caminho para a pasta onde o arquivo está salvo
CURATED_PATH = r"C:\Users\Ana CSP\Desktop\challenge - fiap\arcana NO AWS\dados\curated"
CAMINHO_ARQUIVO_LOCALIZACAO = os.path.join(CURATED_PATH, "df_localizacao_unica_com_lat_long.parquet")
df_localizacao_unica = pd.read_parquet(CAMINHO_ARQUIVO_LOCALIZACAO)
#Copia do DF de localização
df_localizacao_unica_new = df_localizacao_unica.copy()
#Lista de locais em que a longitude e latitude não foram encontradas
#nao_encontradas = df_localizacao_unica[df_localizacao_unica['LATITUDE'].isna() | df_localizacao_unica['LONGITUDE'].isna()]
#cidades_nao_encontradas = nao_encontradas['CIDADE_CLIENTE'].tolist()
#print(cidades_nao_encontradas)

# Mapeamento para corrigir nomes de cidades
mapeamento_cidades = {
    'SAOPAULO': 'SAO PAULO',
    'SANTOANDRE': 'SANTO ANDRE',
    'SAOBERNARDODOCAMPO': 'SAO BERNARDO DO CAMPO',
    'NOVAODESSA': 'NOVA ODESSA',
    'CACHOEIRODEITAPEMIRIM': 'CACHOEIRO DE ITAPEMIRIM',
    'MOGIDASCRUZES': 'MOGI DAS CRUZES',
    'RIOGRANDEDASERRA': 'RIO GRANDE DA SERRA',
    'PORTOALEGRE': 'PORTO ALEGRE',
    'BELOHORIZONTE': 'BELO HORIZONTE',
    'SAOJOSEDOSCAMPOS': 'SAO JOSE DOS CAMPOS',
    'NOVALIMA': 'NOVA LIMA',
    'TABOAODASERRA': 'TABOAO DA SERRA',
    'NOVAFRIBURGO': 'NOVA FRIBURGO',
    'RIBEIRAOPRETO': 'RIBEIRAO PRETO',
    'CAXIASDOSUL': 'CAXIAS DO SUL',
    'TRESCORACOES': 'TRES CORACOES',
    'PORTOFERREIRA': 'PORTO FERREIRA',
    'CHAPADADOSGUIMARAES': 'CHAPADA DOS GUIMARAES',
    'PONTAGROSSA': 'PONTA GROSSA',
    'MORRODAFUMACA': 'MORRO DA FUMACA',
    'FLORESDACUNHA': 'FLORES DA CUNHA',
    'SAOBENTODOSUL': 'SAO BENTO DO SUL',
    'SAOJOSEDOSPINHAIS': 'SAO JOSE DOS PINHAIS',
    'MOJIMIRIM': 'MOJI MIRIM',
    'MATIASBARBOSA': 'MATIAS BARBOSA',
    'SAOCAETANODOSUL': 'SAO CAETANO DO SUL',
    'LAGOASANTA': 'LAGOA SANTA',
    'NOVAIGUACU': 'NOVA IGUACU',
    'SANTABARBARADOESTE': 'SANTA BARBARA DO OESTE',
    'SANTAISABEL': 'SANTA ISABEL',
    'SANTARITADOSAPUCAI': 'SANTA RITA DO SAPUCAI',
    'JUIZDEFORA': 'JUIZ DE FORA',
    'JOAOPESSOA': 'JOAO PESSOA',
    'CAMPOLARGO': 'CAMPO LARGO',
    'TRESLAGOAS': 'TRES LAGOAS',
    'CORUMBADEGOIAS': 'CORUMBA DE GOIAS',
    'CONSELHEIROPENA': 'CONSELHEIRO PENA',
    'BENTOGONCALVES': 'BENTO GONCALVES',
    'DDELESTE': 'CIUDAD DEL ESTE',
    'POUSOALEGRE': 'POUSO ALEGRE',
    'VARZEAGRANDE': 'VARZEA GRANDE',
    'NOVOHAMBURGO': 'NOVO HAMBURGO',
    'SAOCARLOS': 'SAO CARLOS',
    'PONTENOVA': 'PONTE NOVA',
    'CAMPOMOURAO': 'CAMPO MOURAO',
    'ARROIODOMEIO': 'ARROIO DO MEIO',
    'DUQUEDECAXIAS': 'DUQUE DE CAXIAS',
    'BRAGANCAPAULISTA': 'BRAGANCA PAULISTA',
    'SAOLUIS': 'SAO LUIS',
    'PATOSDEMINAS': 'PATOS DE MINAS',
    'VENANCIOAIRES': 'VENANCIO AIRES',
    'PIMENTABUENO': 'PIMENTA BUENO',
    'SANTACRUZDOSUL': 'SANTA CRUZ DO SUL',
    'VITORIADESANTOANTAO': 'VITORIA DE SANTO ANTAO',
    'SAOJOAODEMERITI': 'SAO JOAO DE MERITI',
    'DOISCORREGOS': 'DOIS CORREGOS',
    'SIMOESFILHO': 'SIMOES FILHO',
    'SANTANADEPARNAIBA': 'SANTANA DE PARNAIBA',
    'FERNANDODENORONHA': 'FERNANDO DE NORONHA',
    'MATADESAOJOAO': 'MATA DE SAO JOAO',
    'GOVERNADORVALADARES': 'GOVERNADOR VALADARES',
    'PRESIDENTEPRUDENTE': 'PRESIDENTE PRUDENTE',
    'APARECIDADEGOIANIA': 'APARECIDA DE GOIANIA',
    'SAOLEOPOLDO': 'SAO LEOPOLDO',
    'CARMODOPARANAIBA': 'CARMO DO PARANAIBA',
    'SAOMIGUELDOSCAMPOS': 'SAO MIGUEL DOS CAMPOS',
    'SAOJOSEDORIOPRETO': 'SAO JOSE DO RIO PRETO',
    'SANTAMARIADEJETIBA': 'SANTA MARIA DE JETIBA',
    'CAMPINAGRANDE': 'CAMPINA GRANDE',
    'PATROCINIOPAULISTA': 'PATROCINIO PAULISTA',
    'CAMPOGRANDE': 'CAMPO GRANDE',
    'SANTACECILIA': 'SANTA CECILIA',
    'RIBEIRAODASNEVES': 'RIBEIRAO DAS NEVES',
    'SERAFINACORREA': 'SERAFINA CORREA',
    'SAOSEBASTIAODOPARAISO': 'SAO SEBASTIAO DO PARAISO',
    'TRESPONTAS': 'TRES PONTAS',
    'VARZEAPAULISTA': 'VARZEA PAULISTA',
    'FRANCISCOBELTRAO': 'FRANCISCO BELTRAO',
    'SENADORCANEDO': 'SENADOR CANEDO',
    'FOZDOIGUACU': 'FOZ DO IGUACU',
    'PEREIRABARRETO': 'PEREIRA BARRETO',
    'NOVOMUNDO': 'NOVO MUNDO',
    'SETELAGOAS': 'SETE LAGOAS',
    'RIOBRANCO': 'RIO BRANCO',
    'PORTOVELHO': 'PORTO VELHO',
    'CAMPINAVERDE': 'CAMPINA VERDE',
    'PEDROLEOPOLDO': 'PEDRO LEOPOLDO',
    'SANTARITADOPASSAQUATRO': 'SANTA RITA DO PASSA QUATRO',
    'CABOFRIO': 'CABO FRIO',
    'CAPIVARIDEBAIXO': 'CAPIVARI DE BAIXO',
    'SAOLOURENCODAMATA': 'SAO LOURENCO DA MATA',
    'EMBUDASARTES': 'EMBU DAS ARTES',
    'PIRESDORIO': 'PIRES DO RIO',
    'SANTANADOPARAISO': 'SANTANA DO PARAISO',
    'NOVAVENEZA': 'NOVA VENEZA',
    'JABOATAODOSGUARARAPES': 'JABOATAO DOS GUARARAPES',
    'CORONELFABRICIANO': 'CORONEL FABRICIANO',
    'TRESRIOS': 'TRES RIOS',
    'BELOJARDIM': 'BELO JARDIM',
    'MONTESCLAROS': 'MONTES CLAROS',
    'PARADEMINAS': 'PARA DE MINAS',
    'NOVAOLIMPIA': 'NOVA OLIMPIA',
    'SAOJOSEDALAPA': 'SAO JOSE DA LAPA',
    'DIASDAVILA': 'DIAS D AVILA',
    'SAORAIMUNDODASMANGABEIRAS': 'SAO RAIMUNDO DAS MANGABEIRAS',
    'PAULOAFONSO': 'PAULO AFONSO',
    'POCOSDECALDAS': 'POCOS DE CALDAS',
    'RIOCLARO': 'RIO CLARO',
    'SEBASTIAOLEAL': 'SEBASTIAO LEAL',
    'LUCASDORIOVERDE': 'LUCAS DO RIO VERDE',
    'ABREUELIMA': 'ABREU E LIMA',
    'CAMPOSDOSGOYTACAZES': 'CAMPOS DOS GOYTACAZES',
    'CABODESANTOAGOSTINHO': 'CABO DE SANTO AGOSTINHO',
    'BOMDESPACHO': 'BOM DESPACHO',
    'ANGRADOSREIS': 'ANGRA DOS REIS',
    'CORNELIOPROCOPIO': 'CORNELIO PROCOPIO',
    'FEIRADESANTANA': 'FEIRA DE SANTANA',
    'NOVABASSANO': 'NOVA BASSANO',
    'RIODASOSTRAS': 'RIO DAS OSTRAS',
    'SANTAFEDOSUL': 'SANTA FE DO SUL',
    'BARRAFUNDA': 'BARRA FUNDA',
    'SAOFRANCISCO': 'SAO FRANCISCO',
    'UNIAODAVITORIA': 'UNIAO DA VITORIA',
    'MARECHALDEODORO': 'MARECHAL DEODORO',
    'JUAZEIRODONORTE': 'JUAZEIRO DO NORTE',
    'QUATROBARRAS': 'QUATRO BARRAS',
    'VARGEMGRANDEPAULISTA': 'VARGEM GRANDE PAULISTA',
    'VISTAALEGREDOALTO': 'VISTA ALEGRE DO ALTO',
    'RIOFORMOSO': 'RIO FORMOSO',
    'SANTOANTONIODOMONTE': 'SANTO ANTONIO DO MONTE',
    'ESPIRITOSANTODOPINHAL': 'ESPIRITO SANTO DO PINHAL',
    'VOLTAREDONDA': 'VOLTA REDONDA',
    'SAOJOSEDORIOPARDO': 'SAO JOSE DO RIO PARDO',
    'PARAGUACUPAULISTA': 'PARAGUACU PAULISTA',
    'CORONELVIVIDA': 'CORONEL VIVIDA',
    'SAOJOAO': 'SAO JOAO',
    'NOVAAMERICADACOLINA': 'NOVA AMERICA DA COLINA',
    'FAZENDARIOGRANDE': 'FAZENDA RIO GRANDE',
    'SAOLOURENCODOOESTE': 'SAO LOURENCO DO OESTE',
    'CAMPINAGRANDEDOSUL': 'CAMPINA GRANDE DO SUL',
    'LAURODEFREITAS': 'LAURO DE FREITAS',
    'NOVAPETROPOLIS': 'NOVA PETROPOLIS',
    'NAZAREPAULISTA': 'NAZARE PAULISTA',
    'NOVAPRATA': 'NOVA PRATA',
    'WASHINGTONDC': 'WASHINGTON, DC',
    'ALTOFELIZ': 'ALTO FELIZ',
    'SAOJOAQUIMDEBICAS': 'SAO JOAQUIM DE BICAS',
    'LIMEIRADOOESTE': 'LIMEIRA DO OESTE',
    'ALVARESMACHADO': 'ALVARES MACHADO',
    'NOVAMARILANDIA': 'NOVA MARILANDIA',
    'ALTOHORIZONTE': 'ALTO HORIZONTE',
    'RIBEIRAOPIRES': 'RIBEIRAO PIRES',
    'ARTURNOGUEIRA': 'ARTUR NOGUEIRA',
    'ARMACAODOSBUZIOS': 'ARMACAO DOS BUZIOS',
    'JARAGUADOSUL': 'JARAGUA DO SUL',
    'CAMBARADOSUL': 'CAMBARA DO SUL',
    'CALDASNOVAS': 'CALDAS NOVAS',
    'SAOJOAONEPOMUCENO': 'SAO JOAO NEPOMUCENO',
    'SEBASTIANOPOLISDOSUL': 'SEBASTIANOPOLIS DO SUL',
    'PILARDOSUL': 'PILAR DO SUL',
    'BALNEARIOCAMBORIU': 'BALNEARIO CAMBORIU',
    'SERRATALHADA': 'SERRA TALHADA',
    'CAMPOLIMPOPAULISTA': 'CAMPO LIMPO PAULISTA',
    'RIOQUENTE': 'RIO QUENTE',
    'RIOLARGO': 'RIO LARGO',
    'SAOGONCALO': 'SAO GONCALO',
    'SANTOANTONIODEPADUA': 'SANTO ANTONIO DE PADUA',
    'SANTAMARIADOPARA': 'SANTA MARIA DO PARA',
    'SAOJOAODORIODOPEIXE': 'SAO JOAO DO RIO DO PEIXE',
    'SAOGONCALODOPARA': 'SAO GONCALO DO PARA',
    'TEOFILOOTONI': 'TEOFILO OTONI',
    'BARRADOGARCAS': 'BARRA DO GARCAS',
    'TIBAUDOSUL': 'TIBAU DO SUL',
    'SAOGONCALODOSCAMPOS': 'SAO GONCALO DOS CAMPOS',
    'MUNIZFREIRE': 'MUNIZ FREIRE',
    'VITORIADACONQUISTA': 'VITORIA DA CONQUISTA',
    'CRUZEIRODOSUL': 'CRUZEIRO DO SUL',
    'SAOJOSEDEMIPIBU': 'SAO JOSE DE MIPIBU',
    'BARAODEGRAJAU': 'BARAO DE GRAJAU',
    'TEIXEIRADEFREITAS': 'TEIXEIRA DE FREITAS',
    'SANTOANTONIODEJESUS': 'SANTO ANTONIO DE JESUS',
    'SANTACRUZDORIOPARDO': 'SANTA CRUZ DO RIO PARDO',
    'PORTOSEGURO': 'PORTO SEGURO',
    'VIDALRAMOS': 'VIDAL RAMOS',
    'LIMOEIRODONORTE': 'LIMOEIRO DO NORTE',
    'SANTANADOIPANEMA': 'SANTANA DO IPANEMA',
    'SENADORPOMPEU': 'SENADOR POMPEU',
    'SANTAISABELDOPARA': 'SANTA ISABEL DO PARA',
    'ENTREIJUIS': 'ENTRE IJUIS',
    'CAPAOBONITO': 'CAPAO BONITO',
    'PRESIDENTECASTELOBRANCO': 'PRESIDENTE CASTELO BRANCO',
    'TERRABOA': 'TERRA BOA',
    'RIODOSUL': 'RIO DO SUL',
    'TRESCOROAS': 'TRES COROAS',
    'NOSSASENHORADASDORES': 'NOSSA SENHORA DAS DORES',
    'BRACODONORTE': 'BRACO DO NORTE',
    'FRANCODAROCHA': 'FRANCO DA ROCHA',
    'SAOLUISDEMONTESBELOS': 'SAO LUIS DE MONTES BELOS',
    'PASSOFUNDO': 'PASSO FUNDO',
    'SAOJOAODABOAVISTA': 'SAO JOAO DA BOA VISTA',
    'SAOBENTODOSAPUCAI': 'SAO BENTO DO SAPUCAI',
    'NOSSASENHORADAGLORIA': 'NOSSA SENHORA DA GLORIA',
    'NOVASERRANA': 'NOVA SERRANA',
    'PASTOSBONS': 'PASTOS BONS',
    'NOVASANTARITA': 'NOVA SANTA RITA',
    'BOMJESUSDALAPA': 'BOM JESUS DA LAPA',
    'SAOPEDRODEALCANTARA': 'SAO PEDRO DE ALCANTARA',
    'SAOPEDRODAALDEIA': 'SAO PEDRO DA ALDEIA',
    'ABADIADEGOIAS': 'ABADIA DE GOIAS',
    'OLHODAGUADOCASADO': 'OLHO D AGUA DO CASADO',
    'JOAOCAMARA': 'JOAO CAMARA',
    'SAOMATEUS': 'SAO MATEUS',
    'RIOVERDE': 'RIO VERDE',
    'UNIAODOSPALMARES': 'UNIAO DOS PALMARES',
    'PATOBRANCO': 'PATO BRANCO',
    'BOAVISTADOSUL': 'BOA VISTA DO SUL',
    'PASSAQUATRO': 'PASSA QUATRO',
    'OUROVERDEDOOESTE': 'OURO VERDE DO OESTE',
    'TELEMACOBORBA': 'TELEMACO BORBA',
    'SAOFRANCISCODOSUL': 'SAO FRANCISCO DO SUL',
    'MATEUSLEME': 'MATEUS LEME',
    'PRIMAVERADOLESTE': 'PRIMAVERA DO LESTE',
    'PORTOFELIZ': 'PORTO FELIZ',
    'NOVATRENTO': 'NOVA TRENTO',
    'RIOBRILHANTE': 'RIO BRILHANTE',
    'TRESBARRASDOPARANA': 'TRES BARRAS DO PARANA',
    'RIOBONITO': 'RIO BONITO',
    'NOVAMONTEVERDE': 'NOVA MONTE VERDE',
    'ESPERAFELIZ': 'ESPERA FELIZ',
    'RIOVERDEDEMATOGROSSO': 'RIO VERDE DE MATO GROSSO',
    'SAOGONCALODOAMARANTE': 'SAO GONCALO DO AMARANTE',
    'SANTANADOARAGUAIA': 'SANTANA DO ARAGUAIA',
    'RIONEGRINHO': 'RIO NEGRINHO',
    'PACODOLUMIAR': 'PACO DO LUMIAR',
    'SAOTIAGO': 'SAO TIAGO',
    'MARECHALCANDIDORONDON': 'MARECHAL CANDIDO RONDON',
    'GOVERNADORCELSORAMOS': 'GOVERNADOR CELSO RAMOS',
    'PAULORAMOS': 'PAULO RAMOS',
    'BOMJESUSDOARAGUAIA': 'BOM JESUS DO ARAGUAIA',
    'IGARAPEMIRI': 'IGARAPE MIRI',
    'SAOBERNARDO': 'SAO BERNARDO',
    'SENHORDOBONFIM': 'SENHOR DO BONFIM',
    'NOVAMUTUM': 'NOVA MUTUM',
    'JOAOMONLEVADE': 'JOAO MONLEVADE',
    'RANCHOQUEIMADO': 'RANCHO QUEIMADO',
    'SAPUCAIADOSUL': 'SAPUCAIA DO SUL',
    'MONTESANTODEMINAS': 'MONTE SANTO DE MINAS',
    'BREJODAMADREDEDEUS': 'BREJO DA MADRE DE DEUS',
    'LUISEDUARDOMAGALHAES': 'LUIS EDUARDO MAGALHAES',
    'CERROAZUL': 'CERRO AZUL',
    'SANTOANGELO': 'SANTO ANGELO',
    'SAOJOAOBATISTA': 'SAO JOAO BATISTA',
    'SAOJOAODABALIZA': 'SAO JOAO DA BALIZA',
    'BARRADORIBEIRO': 'BARRA DO RIBEIRO',
    'NOVOCABRAIS': 'NOVO CABRAIS',
    'NOSSASENHORADOSOCORRO': 'NOSSA SENHORA DO SOCORRO',
    'BAIXOGUANDU': 'BAIXO GUANDU',
    'SAOPEDRO': 'SAO PEDRO',
    'SAOSEBASTIAODOCAI': 'SAO SEBASTIAO DO CAI',
    'PRAIAGRANDE': 'PRAIA GRANDE',
    'SANTACRUZDOCAPIBARIBE': 'SANTA CRUZ DO CAPIBARIBE',
    'PORTOCALVO': 'PORTO CALVO',
    'SANTACRUZDOXINGU': 'SANTA CRUZ DO XINGU',
    'BARRABONITA': 'BARRA BONITA',
    'SAOMATEUSDOSUL': 'SAO MATEUS DO SUL',
    'SAOFELIXDOARAGUAIA': 'SAO FELIX DO ARAGUAIA',
    'SERRADOSALITRE': 'SERRA DO SALITRE',
    'ANTONIOCARLOS': 'ANTONIO CARLOS',
    'VALPARAISODEGOIAS': 'VALPARAISO DE GOIAS',
    'CANTODOBURITI': 'CANTO DO BURITI',
    'BELEMDESAOFRANCISCO': 'BELEM DE SAO FRANCISCO',
    'BARRADOPIRAI': 'BARRA DO PIRAI',
    'PIRAIDOSUL': 'PIRAI DO SUL',
    'PAULOLOPES': 'PAULO LOPES',
    'SAOJOSEDOINHACORA': 'SAO JOSE DO INHACORA',
    'ITAPECERICADASERRA': 'ITAPECERICA DA SERRA',
    'BARRADESAOFRANCISCO': 'BARRA DE SAO FRANCISCO',
    'RIBEIRAOBRANCO': 'RIBEIRAO BRANCO',
    'TANGARADASERRA': 'TANGARA DA SERRA',
    'DOUTORPEDRINHO': 'DOUTOR PEDRINHO',
    'CARAZINHO': 'CARAZINHO',
    'SANTATERESA': 'SANTA TERESA',
    'MINEIROSDOTIETE': 'MINEIROS DO TIETE',
    'SAOJOSEDOOURO': 'SAO JOSE DO OURO',
    'BALNEARIOPICARRAS': 'BALNEARIO PICARRAS',
    'PORTODOSGAUCHOS': 'PORTO DOS GAUCHOS',
    'CESARIOLANGE': 'CESARIO LANGE',
    'BELFORDROXO': 'BELFORD ROXO',
    'DOMINGOSMARTINS': 'DOMINGOS MARTINS',
    'GOVERNADOREDISONLOBAO': 'GOVERNADOR EDISON LOBAO',
    'ARACOIABADASERRA': 'ARACOIABA DA SERRA',
    'SAOJOAODELREI': 'SAO JOAO DEL REI',
    'SAOBORJA': 'SAO BORJA',
    'SANTOANTONIODOAMPARO': 'SANTO ANTONIO DO AMPARO',
    'VARGEMGRANDE': 'VARGEM GRANDE',
    'SANTATEREZADOOESTE': 'SANTA TEREZA DO OESTE',
    'BARRAVELHA': 'BARRA VELHA',
    'ILHADASFLORES': 'ILHA DAS FLORES',
    'SANTAMARIADEITABIRA': 'SANTA MARIA DE ITABIRA',
    'NAOMETOQUE': 'NAO ME TOQUE',
    'PORTOREAL': 'PORTO REAL',
    'MARTINHOCAMPOS': 'MARTINHO CAMPOS',
    'SANTARITADECALDAS': 'SANTA RITA DE CALDAS',
    'NOVAPORTEIRINHA': 'NOVA PORTEIRINHA',
    'SALTODEPIRAPORA': 'SALTO DE PIRAPORA',
    'BORDADAMATA': 'BORDA DA MATA',
    'BARRADOSCOQUEIROS': 'BARRA DOS COQUEIROS',
    'ELDORADODOSUL': 'ELDORADO DO SUL',
    'NOVAUBIRATA': 'NOVA UBIRATA',
    'ASTOLFODUTRA': 'ASTOLFO DUTRA',
    'CACAPAVADOSUL': 'CACAPAVA DO SUL',
    'LENCOISPAULISTA': 'LENCOIS PAULISTA',
    'CAMPOLIMPODEGOIAS': 'CAMPO LIMPO DE GOIAS',
    'CAMPOSDOJORDAO': 'CAMPOS DO JORDAO',
    'SANTABRANCA': 'SANTA BRANCA',
    'SAOJOSEDERIBAMAR': 'SAO JOSE DE RIBAMAR',
    'IRAIDEMINAS': 'IRAIDE DE MINAS',
    'NOVAGRANADA': 'NOVA GRANADA',
    'GOVERNADORMANGABEIRA': 'GOVERNADOR MANGABEIRA',
    'CASIMIRODEABREU': 'CASIMIRO DE ABREU',
    'MONTEAZULPAULISTA': 'MONTE AZUL PAULISTA',
    'AGUASDESAOPEDRO': 'AGUAS DE SAO PEDRO',
    'ITAPORANGADAJUDA': 'ITAPORANGA D AJUDA',
    'CAMPONOVODOPARECIS': 'CAMPO NOVO DO PARECIS',
    'CAPELADOALTO': 'CAPELA DO ALTO',
    'PARAIBADOSUL': 'PARAIBA DO SUL',
    'CARMODAMATA': 'CARMO DA MATA',
    'PRUDENTEDEMORAIS': 'PRUDENTE DE MORAIS',
    'NOVOGAMA': 'NOVO GAMA',
    'CAMPOMAGRO': 'CAMPO MAGRO',
    'VARGEMGRANDEDOSUL': 'VARGEM GRANDE DO SUL',
    'SANTOAMARODAIMPERATRIZ': 'SANTO AMARO DA IMPERATRIZ',
    'MONTEALEGREDOPIAUI': 'MONTE ALEGRE DO PIAUI',
    'ALFREDOCHAVES': 'ALFREDO CHAVES',
    'BAIXAGRANDEDORIBEIRO': 'BAIXA GRANDE DO RIBEIRO',
    'SAOMIGUELDOARAGUAIA': 'SAO MIGUEL DO ARAGUAIA',
    'TEREZOPOLISDEGOIAS': 'TEREZOPOLIS DE GOIAS',
    'LAUROMULLER': 'LAURO MULLER',
    'BARAODECOCAIS': 'BARAO DE COCAIS',
    'PARAISODOTOCANTINS': 'PARAISO DO TOCANTINS',
    'BRASILIADEMINAS': 'BRASILIA DE MINAS',
    'SANTOANTONIODOTAUA': 'SANTO ANTONIO DO TAUA',
    'DELMIROGOUVEIA': 'DELMIRO GOUVEIA',
    'OLHODAGUADASFLORES': 'OLHO D AGUA DAS FLORES',
    'TERRAROXA': 'TERRA ROXA',
    'SANTACARMEM': 'SANTA CARMEM',
    'SAODESIDERIO': 'SAO DESIDERIO',
    'PALMEIRADOSINDIOS': 'PALMEIRA DOS INDIOS',
    'FERRAZDEVASCONCELOS': 'FERRAZ DE VASCONCELOS',
    'PONTALDOPARANA': 'PONTAL DO PARANA',
    'CHAPADAODOSUL': 'CHAPADAO DO SUL',
    'SAOMIGUEL': 'SAO MIGUEL',
    'SAOJOAQUIMDABARRA': 'SAO JOAQUIM DA BARRA',
    'CARMODOCAJURU': 'CARMO DO CAJURU',
    'CONCEICAODOCOITE': 'CONCEICAO DO COITE',
    'LARANJALDOJARI': 'LARANJAL DO JARI',
    'PORTONACIONAL': 'PORTO NACIONAL',
    'AGUASLINDASDEGOIAS': 'AGUAS LINDAS DE GOIAS',
    'BOMJESUSDOSPERDOES': 'BOM JESUS DOS PERDOES',
    'NOVAVENECIA': 'NOVA VENECIA',
    'SAOLUISDOQUITUNDE': 'SAO LUIS DO QUITUNDE',
    'LAPAZBOLIVIA': 'LA PAZ',
    'CHAPADAODOCEU': 'CHAPADAO DO CEU',
    'CRUZDASALMAS': 'CRUZ DAS ALMAS',
    'MIMOSODOSUL': 'MIMOSO DO SUL',
    'IGUABAGRANDE': 'IGUABA GRANDE',
    'AGUAAZULDONORTE': 'AGUA AZUL DO NORTE',
    'SAOMIGUELDOGOSTOSO': 'SAO MIGUEL DO GOSTOSO',
    'ROSARIOSANTAFE': 'ROSARIO, SANTA FE',
    'SALTODOJACUI': 'SALTO DO JACUI',
    'DOISVIZINHOS': 'DOIS VIZINHOS',
    'NOVOREPARTIMENTO': 'NOVO REPARTIMENTO',
    'PEDROAFONSO': 'PEDRO AFONSO',
    'CONSELHEIROLAFAIETE': 'CONSELHEIRO LAFAIETE',
    'NOVASANTAROSA': 'NOVA SANTA ROSA',
    'SANTAROSADEVITERBO': 'SANTA ROSA DE VITERBO',
    'PALMEIRASDEGOIAS': 'PALMEIRAS DE GOIAS',
    'AGUASMORNAS': 'AGUAS MORNAS',
    'COMODORARIVADAVIA': 'COMODORO RIVADAVIA',
    'SAOSEBASTIAODOOESTE': 'SAO SEBASTIAO DO OESTE',
    'RIOPOMBA': 'RIO POMBA',
    'RIOCASCA': 'RIO CASCA',
    'SAOMIGUELDOIGUACU': 'SAO MIGUEL DO IGUACU',
    'NOVAMAMORE': 'NOVA MAMORE',
    'AMERICOBRASILIENSE': 'AMERICO BRASILIENSE',
    'AGUACOMPRIDA': 'AGUA COMPRIDA',
    'SAOMARCOS': 'SAO MARCOS',
    'DOISIRMAOS': 'DOIS IRMAOS',
    'BOAESPERANCA': 'BOA ESPERANCA',
    'SAOMIGUELDOGUAMA': 'SAO MIGUEL DO GUAMA',
    'SAOJOAODABARRA': 'SAO JOAO DA BARRA',
    'BARRADOCORDA': 'BARRA DO CORDA',
    'PEIXOTODEAZEVEDO': 'PEIXOTO DE AZEVEDO',
    'CURRAISNOVOS': 'CURRAIS NOVOS',
    'NOVALACERDA': 'NOVA LACERDA',
    'SAOJOAOBATISTADOGLORIA': 'SAO JOAO BATISTA DO GLORIA',
    'SAOCRISTOVAO': 'SAO CRISTOVAO',
    'BELACRUZ': 'BELA CRUZ',
    'MONTEDOCARMO': 'MONTE DO CARMO',
    'SAOLUDGERO': 'SAO LUDGERO',
    'CANAADOSCARAJAS': 'CANA DOS CARAJAS',
    'AGUASDELINDOIA': 'AGUAS DE LINDOIA',
    'PAUDOSFERROS': 'PAU DOS FERROS',
    'CARLOSBARBOSA': 'CARLOS BARBOSA',
    'RAULSOARES': 'RAUL SOARES',
    'SAOJOAODOPARAISO': 'SAO JOAO DO PARAISO',
    'BELOVALE': 'BELO VALE',
    'CAMPOMAIOR': 'CAMPO MAIOR',
    'SALTOVELOSO': 'SALTO VELOSO',
    'LAGOANOVA': 'LAGOA NOVA',
    'CIDADEOCIDENTAL': 'CIDADE OCIDENTAL',
    'PRESIDENTEMEDICI': 'PRESIDENTE MEDICI',
    'SAOMIGUELDOOESTE': 'SAO MIGUEL DO OESTE',
    'NOVAROMA': 'NOVA ROMA',
    'APARECIDADOTABOADO': 'APARECIDA DO TABOADO',
    'OLHODAGUADASCUNHAS': 'OLHO D AGUA DAS CUNHAS',
    'CAJUEIRODAPRAIA': 'CAJUEIRO DA PRAIA',
    'VALEREAL': 'VALE REAL',
    'BOMRETIRODOSUL': 'BOM RETIRO DO SUL',
    'TRIZIDELADOVALE': 'TRIZIDELA DO VALE',
    'JACINTOMACHADO': 'JACINTO MACHADO',
    'GUAJARAMIRIM': 'GUAJARA-MIRIM',
    'LIMADUARTE': 'LIMA DUARTE',
    'NEVESPAULISTA': 'NEVES PAULISTA',
    'BOMPRINCIPIO': 'BOM PRINCIPIO',
    'PRESIDENTEEPITACIO': 'PRESIDENTE EPITACIO',
    'SAODOMINGOSDOMARANHAO': 'SAO DOMINGOS DO MARANHAO',
    'VARZEADOPOCO': 'VARZEA DO POCO',
    'SANTOANTONIODOARACANGUA': 'SANTO ANTONIO DO ARACANGUA',
    'SAOGABRIELDOOESTE': 'SAO GABRIEL DO OESTE',
    'ELCALAFATESANTACRUZ': 'EL CALAFATE, SANTA CRUZ',
    'AMERICANODOBRASIL': 'AMERICANO DO BRASIL',
    'AGUABRANCA': 'AGUA BRANCA',
    'LARANJALPAULISTA': 'LARANJAL PAULISTA',
    'SAOSIMAO': 'SAO SIMAO',
    'DONAEMMA': 'DONA EMMA',
    'PADREBERNARDO': 'PADRE BERNARDO',
    'SANTOANTONIODEPOSSE': 'SANTO ANTONIO DE POSSE',
    'CAPITAOPOCO': 'CAPITAO POCO',
    'NOVAMARINGA': 'NOVA MARINGA',
    'SAOGOTARDO': 'SAO GOTARDO',
    'AREIABRANCA': 'AREIA BRANCA',
    'IGARACUDOTIETE': 'IGARACU DO TIETE',
    'MARIADAFE': 'MARIA DA FE',
    'LAGOASALGADA': 'LAGOA SALGADA',
    'CDADAUTONOMADEBUENOSAIRES': 'CIUDAD AUTONOMA DE BUENOS AIRES',
    'TEODOROSAMPAIO': 'TEODORO SAMPAIO',
    'PUERTOIGUAZU': 'PUERTO IGUAZU',
    'VILLADEMERLOSANLUIS': 'VILLA DE MERLO, SAN LUIS',
    'SANNICOLAS': 'SAN NICOLAS',
    'SANTIAGODECHILE': 'SANTIAGO, CHILE'
}

#ATUALIZAÇÃO DO NOME DAS CIDADES:
df_localizacao_unica_new['CIDADE_CLIENTE'] = df_localizacao_unica_new['CIDADE_CLIENTE'].replace(mapeamento_cidades)

# --- Filtrar e geocodificar APENAS os registros com NaN ---
# Identifica os registros que ainda precisam de geocodificação
df_para_geocodificar = df_localizacao_unica_new[df_localizacao_unica_new['LATITUDE'].isna()].copy()
print(f"Número de combinações a serem geocodificadas novamente: {len(df_para_geocodificar)}")

# --- Etapa 3: Rodar a geocodificação novamente (apenas para o subconjunto) ---
geolocator = Nominatim(user_agent="meu_aplicativo_geocodificacao")

def get_coordinates_otimizado(row):
    try:
        time.sleep(1.2)
        location_name = f"{row['CIDADE_CLIENTE']}, {row['PAIS_CLIENTE']}"
        location = geolocator.geocode(location_name, timeout=10)
        
        if location:
            print(f"Encontrado: {location_name} -> ({location.latitude}, {location.longitude})")
            return pd.Series([location.latitude, location.longitude])
        else:
            print(f"Não encontrado: {location_name}")
            return pd.Series([None, None])
            
    except (GeocoderTimedOut, GeocoderUnavailable) as e:
        print(f"Erro de geocodificação para {location_name}: {e}")
        return pd.Series([None, None])
    except Exception as e:
        print(f"Ocorreu um erro inesperado: {e}")
        return pd.Series([None, None])

print("\nIniciando a geocodificação dos registros ausentes...")
df_para_geocodificar[['LATITUDE', 'LONGITUDE']] = df_para_geocodificar.apply(get_coordinates_otimizado, axis=1)

# --- Etapa 4: Atualizar o DataFrame original com os novos dados ---
# Atualiza as colunas de Latitude e Longitude no DataFrame principal
df_localizacao_unica_new.update(df_para_geocodificar)

print("\nGeocodificação concluída. Exemplo do DataFrame atualizado:")
print(df_localizacao_unica_new.head())

# --- Etapa 5: Salvar o DataFrame atualizado ---
NOVO_CAMINHO_ARQUIVO = os.path.join(CURATED_PATH, "df_localizacao_unica_atualizada.parquet")
df_localizacao_unica_new.to_parquet(NOVO_CAMINHO_ARQUIVO)
print(f"\nO DataFrame de localizações atualizado foi salvo em: {NOVO_CAMINHO_ARQUIVO}")
